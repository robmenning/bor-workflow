# JWT Authentication in BOR API

## Overview

The BOR API uses JSON Web Tokens (JWT) for authentication and authorization. The tokens are created by the bor-app application during user login and passed to the BOR API with each request. The API validates these tokens and extracts user information, roles, and permissions to implement Role-Based Access Control (RBAC).

## Authentication Flow

1. **Token Creation**: bor-app creates JWTs with user roles and permissions during login
2. **Token Transmission**: bor-app includes the JWT in API requests to BOR API
3. **Token Validation**: BOR API validates the token signature and expiration
4. **Permission Extraction**: JWT payload contains user roles and permissions
5. **Authorization**: Middleware checks if the user has required permissions

## JWT Payload Structure

The actual JWT payload structure used by BOR API:

```json
{
  "id": "cla7891bd00003b1jk3dm5pql",
  "name": "Jane Smith",
  "email": "jane@example.com",
  "borUserId": 42,
  "roles": ["admin", "dataadmin"],
  "permissions": ["port:read", "port:create", "port:update", "port:delete", "instr:read"],
  "roleIds": ["admin", "dataadmin"],
  "permissionIds": ["port:read", "port:create", "port:update", "port:delete", "instr:read"],
  "isApproved": true,
  "iat": 1625097600,
  "exp": 1625184000
}
```

### Required Fields

**Required fields for authentication:**
- `id`: User identifier (string)
- `isApproved`: Boolean indicating if user account is approved
- `iat`: Issued at timestamp (number)
- `exp`: Expiration timestamp (number)

**Required fields for authorization:**
- `roleIds`: Array of role identifiers (string[])
- `permissionIds`: Array of permission identifiers (string[])

**Optional fields:**
- `name`: User's display name
- `email`: User's email address
- `borUserId`: Numeric user ID
- `roles`: Legacy roles array (deprecated, use `roleIds`)
- `permissions`: Legacy permissions array (deprecated, use `permissionIds`)

## JWT Secret & Configuration

### Environment Variables

**Primary Secret:**
- `NEXTAUTH_SECRET`: The JWT secret used for token validation
- **Fallback**: `'your_nextauth_secret_here'` (development only)

**Algorithm:**
- **Default**: HS256 (HMAC SHA-256)
- **Library**: Uses `jsonwebtoken` npm package

### Configuration Notes

- Both bor-app and bor-api must use the same `NEXTAUTH_SECRET`
- The secret should be a strong, randomly generated string
- In production, always set `NEXTAUTH_SECRET` environment variable
- Never use the fallback secret in production

## Authentication Endpoints

### No Direct Authentication Endpoints

**Important**: BOR API does NOT provide authentication endpoints. JWT tokens are created by bor-app during user login and passed to BOR API.

**Token Source:**
- Tokens are generated by bor-app using NextAuth.js
- bor-app handles user login, password validation, and token creation
- BOR API only validates tokens, it does not create them

### Service Account Approach

**Current Implementation:**
- No dedicated service accounts for automated workflows
- All authentication goes through bor-app's user system
- Workflows must use valid user credentials

**Recommended Approach for bor-workflow:**
1. Create a dedicated service user in bor-app
2. Generate a long-lived JWT token for this service user
3. Configure bor-workflow to use this token
4. Ensure the service user has `dataadmin` role and required permissions

## Token Validation Process

### Validation Steps

1. **Header Check**: Validates `Authorization: Bearer <token>` format
2. **Token Extraction**: Extracts token from Bearer header
3. **Secret Verification**: Uses `NEXTAUTH_SECRET` to verify signature
4. **Expiration Check**: Validates `exp` claim against current time
5. **Approval Check**: Ensures `isApproved: true`
6. **User Assignment**: Attaches decoded user to `req.user`

### Error Responses

**401 Unauthorized:**
```json
{
  "error": "Authentication required"
}
```

**401 Invalid Token:**
```json
{
  "error": "Invalid or expired token",
  "details": "TokenExpiredError: jwt expired" // Only in development
}
```

**403 Not Approved:**
```json
{
  "error": "Account not approved"
}
```

## Permissions & Roles

### Required Permissions for Endpoints

**`/data/factset-holdings` endpoint:**
- **Role Required**: `dataadmin`
- **Permissions**: No specific permissions required (role-based access)

**Workflow endpoints (`/workflows/factset-out-hold/*`):**
- **Role Required**: `dataadmin`
- **Permissions**: No specific permissions required (role-based access)

### Available Roles

- `admin`: Full system access
- `dataadmin`: Data management and workflow access
- `user`: Basic user access

### Available Permissions

- `port:read`: Read portfolio data
- `port:create`: Create portfolios
- `port:update`: Update portfolios
- `port:delete`: Delete portfolios
- `instr:read`: Read instrument data

### Minimum Requirements for bor-workflow

**For `/data/factset-holdings` access:**
```json
{
  "roleIds": ["dataadmin"],
  "isApproved": true
}
```

## Environment Differences

### Development Environment

**Authentication Bypass:**
- `SKIP_AUTH_FOR_TESTS=true` bypasses JWT validation
- Provides mock user with full permissions:
```json
{
  "id": "1",
  "name": "Test User",
  "email": "test@example.com",
  "borUserId": 1,
  "roles": ["admin", "dataadmin"],
  "permissions": ["port:read", "port:create", "port:update", "port:delete", "instr:read"],
  "roleIds": ["admin", "dataadmin"],
  "permissionIds": ["port:read", "port:create", "port:update", "port:delete", "instr:read"],
  "isApproved": true
}
```

### Production Environment

**Strict Authentication:**
- `SKIP_AUTH_FOR_TESTS` should be `false` or unset
- All requests require valid JWT tokens
- No authentication bypass available

## Implementation for bor-workflow

### Step 1: Create Service User

In bor-app, create a dedicated service user:
- Email: `workflow-service@bor-system.com`
- Role: `dataadmin`
- Approved: `true`

### Step 2: Generate Long-lived Token

Use bor-app's token generation to create a JWT for the service user:
```javascript
// In bor-app, generate token for workflow service
const token = jwt.sign({
  id: 'workflow-service-id',
  email: 'workflow-service@bor-system.com',
  roleIds: ['dataadmin'],
  permissionIds: ['port:read', 'instr:read'],
  isApproved: true,
  iat: Math.floor(Date.now() / 1000),
  exp: Math.floor(Date.now() / 1000) + (30 * 24 * 60 * 60) // 30 days
}, process.env.NEXTAUTH_SECRET);
```

### Step 3: Configure bor-workflow

Set the token in bor-workflow environment:
```bash
export BOR_API_TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

### Step 4: Use in API Calls

```python
# In bor-workflow Python code
import requests

headers = {
    'Authorization': f'Bearer {os.environ["BOR_API_TOKEN"]}',
    'Content-Type': 'application/json'
}

response = requests.get(
    'http://bor-api:4410/data/factset-holdings?dateValId=2025-04-14',
    headers=headers
)
```

## Middleware Components

BOR API includes the following authentication and authorization middleware:

1. **`authenticateJWT`**: Validates the JWT and extracts user information
2. **`requirePermission`**: Checks if the user has a specific permission
3. **`requireRole`**: Checks if the user has a specific role

## Usage Examples

```typescript
// Example route with authentication and role check
import { authenticateJWT, requireRole } from '../middleware/auth';

router.get('/data/factset-holdings', 
  authenticateJWT,
  requireRole('dataadmin'),
  dataController.getFactsetOutHold
);

// Example route with permission check
router.get('/portfolios', 
  authenticateJWT,
  requirePermission('port:read'),
  portfolioController.listPortfolios
);
```

## Important Notes

### Legacy Field Support

The API supports both legacy and new field names:
- `roles` → `roleIds` (new preferred field)
- `permissions` → `permissionIds` (new preferred field)

### Security Considerations

1. **Secret Management**: Both bor-app and bor-api must use the same `NEXTAUTH_SECRET`
2. **Token Expiration**: Tokens have a limited lifespan (typically 30 days)
3. **Transport Security**: All API communications should use HTTPS
4. **Token Storage**: Store service tokens securely in environment variables
5. **Regular Rotation**: Rotate service tokens periodically

### Troubleshooting

**Common Issues:**
1. **"Invalid or expired token"**: Check token expiration and secret
2. **"Account not approved"**: Ensure user has `isApproved: true`
3. **"Insufficient permissions"**: Verify user has required `roleIds` or `permissionIds`
4. **"Authentication required"**: Missing or malformed Authorization header 